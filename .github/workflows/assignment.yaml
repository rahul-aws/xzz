name: Build and publish a Docker image
on: workflow_dispatch  # You can trigger this workflow manually or on other events (push, pull_request)

jobs:
  build:
    name: Build & push Docker image
    runs-on: ubuntu-latest  # You can choose a different runner (e.g., ubuntu-18.04) if needed
    env:
      IMG_NAME: "ra03/<image>"  # Replace "<image>" with your desired image name

    steps:
      - name: Checkout
        uses: actions/checkout@v3  # Downloads your code from the repository

      - name: Debug (Optional)
        run: |  # Optional step to see the current branch/tag reference
          echo "github.ref -> {{ github.ref }}"

      - name: Docker metadata
        id: metadata
        uses: docker/metadata-action@v3  # Generates metadata for your image tags
        with:
          images: ${{ env.IMG_NAME }}
          tags: |  # Defines different tag formats (version, major.minor, sha)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value={{sha}},enable=${{ github.ref_type != 'tag' }}

      - name: Login to GitHub Packages  # Authenticates with your registry
        uses: docker/login-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # Uses a secret for your PAT

      - name: Build and push Docker image
        uses: docker/build-push-action@v2  # Builds and pushes the image
        with:
          context: .  # Builds the image from the current directory
          push: ${{ github.ref_type == 'tag' }}  # Pushes only for tags (not branches)
          tags: rahul0526/test:v0  # Update with your desired image tag for GitHub Packages
          labels: ${{ steps.metadata.outputs.labels }}  # Uses labels generated by docker/metadata-action

